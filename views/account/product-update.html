<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Update Product</title>
    <link rel="stylesheet" href="/assets/desktop-shared.css">
    <link rel="stylesheet" href="/assets/admin-product.css">
    <link rel="stylesheet" href="/assets/moblie-nav.css">
</head>

<body>

    <nav class="mobile-nav">
        <a href="/" class="mobile-logo">dokmai4u Shop</a>
        <div id="hamburger-icon" class="hamburger-icon">
            <span></span>
            <span></span>
            <span></span>
        </div>
    </nav>
    <div id="mobile-menu" class="mobile-menu">
        <a href="/">Home</a>
        <a href="/search">Search</a>
        <a href="/account">Account</a>
        <a href="/product">Product</a>
    </div>

    <nav class="desktop-nav">
        <a href="/" class="logo">dokmai4u Shop</a>
        <div class="nav-links">
            <a href="/">Home</a>
            <a href="/search">Search</a>
            <a href="/account">Account</a>
            <a href="/product">Product</a>
        </div>
    </nav>

    <div class="page-wrapper">
        <main class="main-content">
            <div class="admin-container">

                <form id="updateForm" class="admin-form">
                    <div class="product-icon-large">üíê</div>

                    <input type="hidden" id="FlowerID" name="FlowerID" />

                    <div class="form-group">
                        <label for="Name">Name</label>
                        <input type="text" id="Name" name="FlowerName" placeholder="Enter flower name" required />
                    </div>

                    <div class="form-group">
                        <label for="Category">Category</label>
                        <div class="select-wrapper">
                            <!-- ‡πÉ‡∏´‡πâ name="CID" ‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡πÅ‡∏ö‡πá‡∏Å‡πÄ‡∏≠‡∏ô‡∏î‡πå -->
                            <select id="Category" name="CID" required>
                                <option value="1">Bouquet</option>
                                <option value="2">Gift Set</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="Price">Price</label>
                        <input type="number" id="Price" name="Price" placeholder="Enter flower price" min="0" step="1"
                            required />
                    </div>

                    <div class="form-group">
                        <label for="StartDate">Available</label>
                        <div class="date-range-inputs">
                            <input type="date" id="StartDate" name="StartDate" />
                            <span>to</span>
                            <input type="date" id="EndDate" name="EndDate" />
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="Meaning">Meaning</label>
                        <textarea id="Meaning" name="Meaning" placeholder="Enter flower meaning" required></textarea>
                    </div>

                    <div id="result" style="color: rgb(200, 0, 0);"></div>
                    <button type="submit" class="btn-primary">Update</button>
                </form>
            </div>
        </main>
    </div>

    <script src="/assets/moblie-nav.js" defer></script>
    <script>
        // ===== Helpers =====
        const $ = (id) => document.getElementById(id);

        // ‡∏ï‡∏±‡∏î‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏¥‡πâ‡∏á ‡πÉ‡∏´‡πâ‡πÄ‡∏´‡∏•‡∏∑‡∏≠ YYYY-MM-DD (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö input type=date)
        const toDateInput = (v) => {
            if (!v) return '';
            // ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏ó‡∏±‡πâ‡∏á 'YYYY-MM-DD' ‡πÅ‡∏•‡∏∞ 'YYYY-MM-DDTHH:mm:ss'
            return String(v).slice(0, 10);
        };

        // ===== Get :id ‡∏à‡∏≤‡∏Å path /product/update/:id =====
        const parts = location.pathname.split('/').filter(Boolean);
        const id = parts[parts.length - 1];

        const resultDiv = $('result');

        async function loadData() {
            try {
                const res = await fetch(`/product/api/product/${id}`);
                if (!res.ok) {
                    resultDiv.textContent = 'No results found!';
                    return;
                }
                const data = await res.json();

                $('FlowerID').value = data.FlowerID ?? '';
                $('Name').value = data.FlowerName ?? '';
                // ‡πÉ‡∏ä‡πâ CID (‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç) ‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö <option value="...">
                $('Category').value = String(data.CID ?? '');
                $('Price').value = data.Price ?? '';
                $('StartDate').value = toDateInput(data.StartDate);
                $('EndDate').value = toDateInput(data.EndDate);
                $('Meaning').value = data.Meaning ?? '';
            } catch (e) {
                console.error(e);
                resultDiv.textContent = 'Load data error!';
            }
        }

        $('updateForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const payload = {
                FlowerName: $('Name').value.trim(),
                CID: Number($('Category').value),         // ‚Üê number
                Price: Number($('Price').value),          // ‚Üê number
                StartDate: $('StartDate').value || null,  // ‡∏™‡πà‡∏á null ‡∏ñ‡πâ‡∏≤‡πÄ‡∏ß‡πâ‡∏ô‡∏ß‡πà‡∏≤‡∏á
                EndDate: $('EndDate').value || null,
                Meaning: $('Meaning').value.trim(),
            };

            // validate ‡∏á‡πà‡∏≤‡∏¢‡πÜ ‡∏ù‡∏±‡πà‡∏á‡∏´‡∏ô‡πâ‡∏≤
            if (!payload.FlowerName || !payload.Price || !payload.Meaning) {
                resultDiv.textContent = 'FlowerName, Price, Meaning are required';
                return;
            }

            try {
                const res = await fetch(`/product/update/${id}`, {
                    method: 'PUT', // ‡∏ñ‡πâ‡∏≤‡∏≠‡∏¢‡∏≤‡∏Å‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô PUT ‡∏Å‡πá‡πÑ‡∏î‡πâ ‡πÅ‡∏ï‡πà‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö route ‡∏ù‡∏±‡πà‡∏á server
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload),
                });

                const data = await res.json().catch(() => ({}));
                if (!res.ok) {
                    resultDiv.textContent = data?.message || 'Update failed!';
                    return;
                }

                resultDiv.style.color = 'green';
                resultDiv.textContent = 'Update Success!';
            } catch (e) {
                console.error(e);
                resultDiv.textContent = 'There was an error updating.';
            }
        });

        loadData();
    </script>
</body>

</html>